{"version":3,"sources":["../../src/middleware/csrf.js"],"names":["run","csrf","config","think","session","http","_session","isGet","isPost","isAjax","isJsonp","get","session_name","value","uuid","set","view","assign","form_name","formValue","header","fail","errno","errmsg","middleware","base"],"mappings":"AAAA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKE;;;;mBAIMA,G;;;;;;;;AACAC,kB,GAAO,KAAKC,MAAL,CAAY,MAAZ,C;;AACXC,oBAAMC,OAAN,CAAc,KAAKC,IAAnB;AACID,qB,GAAU,KAAKC,IAAL,CAAUC,Q;AACpBC,mB,GAAQ,KAAKF,IAAL,CAAUE,KAAV,E;AACRC,oB,GAAS,KAAKH,IAAL,CAAUG,MAAV,E;AACTC,oB,GAAS,KAAKJ,IAAL,CAAUI,MAAV,E;AACTC,qB,GAAU,KAAKL,IAAL,CAAUK,OAAV,E;;oBAEVH,SAAS,CAACE,MAAV,IAAoB,CAACC,O;;;;;;qBACLN,QAAQO,GAAR,CAAYV,KAAKW,YAAjB,C;;;AAAdC,mB;;kBACCA,K;;;;;AACHA,sBAAQV,MAAMW,IAAN,CAAW,EAAX,CAAR;;qBACMV,QAAQW,GAAR,CAAYd,KAAKW,YAAjB,EAA+BC,KAA/B,C;;;AAER,mBAAKR,IAAL,CAAUW,IAAV,GAAiBC,MAAjB,CAAwBhB,KAAKiB,SAA7B,EAAwCL,KAAxC;;;;;oBACSL,UAAUC,MAAV,IAAoBC,O;;;;;;qBACXN,QAAQO,GAAR,CAAYV,KAAKW,YAAjB,C;;;AAAdC,oB;AACAM,uB,GAAY,KAAKd,IAAL,CAAUG,SAAS,MAAT,GAAkB,OAA5B,EAAqCP,KAAKiB,SAA1C,C;;AAChB,kBAAG,CAACC,SAAJ,EAAc;AACZA,4BAAY,KAAKd,IAAL,CAAUe,MAAV,CAAiB,OAAOnB,KAAKiB,SAA7B,CAAZ;AACD;;oBACG,CAACL,MAAD,IAAUM,cAAcN,M;;;;;+CACnB,KAAKR,IAAL,CAAUgB,IAAV,CAAepB,KAAKqB,KAApB,EAA2BrB,KAAKsB,MAAhC,C;;;;;;;;;;;;;;;;;;EA5BcpB,MAAMqB,UAAN,CAAiBC,I","file":"csrf.js","sourcesContent":["'use strict';\n/**\n * check csrf\n * @type {}\n */\nexport default class extends think.middleware.base {\n  /**\n   * run\n   * @return {Promise} []\n   */\n  async run() {\n    let csrf = this.config('csrf');\n    think.session(this.http);\n    let session = this.http._session;\n    let isGet = this.http.isGet();\n    let isPost = this.http.isPost();\n    let isAjax = this.http.isAjax();\n    let isJsonp = this.http.isJsonp();\n\n    if (isGet && !isAjax && !isJsonp) {\n      let value = await session.get(csrf.session_name);\n      if (!value) {\n        value = think.uuid(32);\n        await session.set(csrf.session_name, value);\n      }\n      this.http.view().assign(csrf.form_name, value);\n    } else if (isPost || isAjax || isJsonp) {\n      let value = await session.get(csrf.session_name);\n      let formValue = this.http[isPost ? 'post' : 'param'](csrf.form_name);\n      if(!formValue){\n        formValue = this.http.header('x-' + csrf.form_name);\n      }\n      if (!value || formValue !== value) {\n        return this.http.fail(csrf.errno, csrf.errmsg);\n      }\n    }\n  }\n}"]}