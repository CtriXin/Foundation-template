{"version":3,"sources":["../../src/middleware/locate_template.js"],"names":["getPathPrefix","module","pathPrefix","http","prefix","root_path","options","theme","lang","_langAsViewPath","think","sep","normalize","mode","mode_module","getPath","dirname","view","run","isObject","extend","templateFile","config","isAbsolute","file_depr","file_ext","controller","replace","action","paths","split","length","index","indexOf","newController","slice","join","middleware","base"],"mappings":"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","file":"locate_template.js","sourcesContent":["'use strict';\n\nimport path from 'path';\n/**\n * find template file path\n * @param  {String}  \n * @return {Class}\n */\nexport default class extends think.middleware.base {\n  /**\n   * get path prefix\n   * @return {String} []\n   */\n  getPathPrefix(module){\n    let pathPrefix, http = this.http, prefix = '';\n    let {root_path} = this.options;\n    let theme = http.theme();\n    let lang = http._langAsViewPath && http.lang();\n    \n    module = module || http.module;\n    \n    //support locale\n    if(lang){\n      prefix += think.sep + lang;\n    }\n    //support theme\n    if(theme){\n      prefix += think.sep + theme;\n    }\n\n    //view root path is defined\n    if(root_path){\n      pathPrefix = path.normalize(root_path);\n      if(think.mode === think.mode_module){\n        pathPrefix += prefix + think.sep + module;\n      }\n    }else{\n      pathPrefix = think.getPath(module, think.dirname.view, prefix);\n    }\n\n    return pathPrefix;\n  }\n  /**\n   * run\n   * @param  {String} templateFile [template filepath]\n   * @return {}              []\n   */\n  run(options){\n    if(!think.isObject(options)){\n      options = think.extend({\n        templateFile: options\n      }, this.config('view'));\n    }\n    this.options = options;\n\n    let templateFile = options.templateFile;\n    //is absolute file path\n    if(templateFile && path.isAbsolute(templateFile)){\n      return templateFile;\n    }\n    let http = this.http;\n    let {file_depr, file_ext} = options;\n    let pathPrefix = this.getPathPrefix();\n    let controller = http.controller.replace(/\\//g, think.sep);\n\n    //if file_depr is /, replace to think.sep, avoid error on windows\n    if(file_depr === '/'){\n      file_depr = think.sep;\n    }\n\n    // this.display()\n    if (!templateFile) {\n      return pathPrefix + think.sep + controller + file_depr + http.action + file_ext;\n    }\n    //replace : to /\n    templateFile = templateFile.replace(/\\:/g, '/');\n\n    // this.display('detail')\n    // this.display('index/detail')\n    // this.display('admin/index/detail')\n    // this.display('admin/index/detail.html')\n    let paths = templateFile.split('/');\n    let length = paths.length;\n    let action = paths[length - 1];\n\n    let module;\n    if(length === 2){\n      controller = paths[0];\n    }else if(length > 2){\n      let index = think.module.indexOf(paths[0]) > -1 ? 1 : 0;\n      if(index){\n        module = paths[0];\n      }\n      let newController = paths.slice(index, length - 1).join(think.sep);\n      if(newController){\n        controller = newController;\n      }\n    }\n\n    if (module && module !== http.module) {\n      pathPrefix = this.getPathPrefix(module);\n    }\n\n    templateFile = pathPrefix + think.sep + controller + file_depr + action;\n    if (action.indexOf('.') === -1) {\n      templateFile += file_ext;\n    }\n    return templateFile;\n  }\n}"]}