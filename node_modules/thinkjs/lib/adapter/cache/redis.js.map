{"version":3,"sources":["../../../src/adapter/cache/redis.js"],"names":["RedisSocket","think","adapter","init","options","parseConfig","config","timeout","prefix","getRedisInstance","name","call","command","from","getInstance","thinkCache","REDIS","get","instance","then","value","JSON","parse","catch","set","isObject","key","delete","wrap","data","base"],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAIA,cAAcC,MAAMC,OAAN,CAAc,QAAd,EAAwB,OAAxB,CAAlB;;AAEA;;;;;;;;;;;;AAIE;;;;;mBAKAC,I,iBAAKC,O,EAAQ;AACX,SAAKA,OAAL,GAAeH,MAAMI,WAAN,CAAkBJ,MAAMK,MAAN,CAAa,OAAb,CAAlB,EAAyCF,OAAzC,CAAf;AACA,SAAKG,OAAL,GAAe,KAAKH,OAAL,CAAaG,OAAb,IAAwB,CAAvC;AACA,SAAKC,MAAL,GAAc,KAAKJ,OAAL,CAAaI,MAAb,IAAuB,EAArC;AACD,G;AACD;;;;;;mBAIAC,gB,6BAAiBC,I,EAAK;AACpB,QAAIN,UAAUH,MAAMI,WAAN,CAAkBM,IAAlB,CAAuB,KAAKP,OAA5B,EAAqCH,MAAMK,MAAN,CAAa,OAAb,CAArC,EAA4D;AACxEM,eAASF,IAD+D;AAExEG,YAAM;AAFkE,KAA5D,CAAd;AAIA,SAAKN,OAAL,GAAeH,QAAQG,OAAR,IAAmB,KAAKA,OAAvC;AACA,SAAKC,MAAL,GAAcJ,QAAQI,MAAR,IAAkB,KAAKA,MAArC;AACA,WAAOR,YAAYc,WAAZ,CAAwBV,OAAxB,EAAiCW,WAAWC,KAA5C,EAAmD,CAAC,SAAD,EAAY,MAAZ,CAAnD,CAAP;AACD,G;AACD;;;;;;;mBAKAC,G,gBAAIP,I,EAAK;AACP,QAAIQ,WAAW,KAAKT,gBAAL,CAAsB,KAAtB,CAAf;AACA,WAAOS,SAASD,GAAT,CAAa,KAAKT,MAAL,GAAcE,IAA3B,EAAiCS,IAAjC,CAAsC,iBAAS;AACpD,UAAIC,KAAJ,EAAW;AACT,eAAOC,KAAKC,KAAL,CAAWF,KAAX,CAAP;AACD;AACF,KAJM,EAIJG,KAJI,CAIE,YAAM,CAAE,CAJV,CAAP;AAKD,G;AACD;;;;;;;;mBAMAC,G,gBAAId,I,EAAMU,K,EAA8B;AAAA,QAAvBb,OAAuB,uEAAb,KAAKA,OAAQ;;AACtC,QAAIN,MAAMwB,QAAN,CAAef,IAAf,CAAJ,EAA0B;AACxBH,gBAAUa,SAASb,OAAnB;AACA,UAAImB,MAAM,oBAAYhB,IAAZ,EAAkB,CAAlB,CAAV;AACAU,cAAQV,KAAKgB,GAAL,CAAR;AACAhB,aAAOgB,GAAP;AACD;AACD,QAAIR,WAAW,KAAKT,gBAAL,CAAsB,KAAtB,CAAf;AACA,WAAOS,SAASM,GAAT,CAAa,KAAKhB,MAAL,GAAcE,IAA3B,EAAiC,yBAAeU,KAAf,CAAjC,EAAwDb,OAAxD,EAAiEgB,KAAjE,CAAuE,YAAM,CAAE,CAA/E,CAAP;AACD,G;AACD;;;;;;;mBAKAI,M,oBAAOjB,I,EAAK;AACV,QAAIQ,WAAW,KAAKT,gBAAL,CAAsB,QAAtB,CAAf;AACA,WAAOS,SAASS,MAAT,CAAgB,KAAKnB,MAAL,GAAcE,IAA9B,EAAoCa,KAApC,CAA0C,YAAM,CAAE,CAAlD,CAAP;AACD,G;AACD;;;;;;;;mBAMAK,I,iBAAKhB,O,EAASF,I,EAAc;AAC1B,QAAIQ,WAAW,KAAKT,gBAAL,CAAsBG,OAAtB,CAAf;;AAD0B,sCAALiB,IAAK;AAALA,UAAK;AAAA;;AAE1B,WAAOX,SAASU,IAAT,kBAAchB,OAAd,EAAuB,KAAKJ,MAAL,GAAcE,IAArC,SAA8CmB,IAA9C,EAAP;AACD,G;;;EAvE0B5B,MAAMC,OAAN,CAAc4B,I","file":"redis.js","sourcesContent":["'use strict';\n\nlet RedisSocket = think.adapter('socket', 'redis');\n\n/**\n * redis cache\n */\nexport default class extends think.adapter.base {\n  /**\n   * init\n   * @param  {Object} options []\n   * @return {}         []\n   */\n  init(options){\n    this.options = think.parseConfig(think.config('cache'), options);\n    this.timeout = this.options.timeout || 0;\n    this.prefix = this.options.prefix || '';\n  }\n  /**\n   * get redis instance\n   * @return {Object} []\n   */\n  getRedisInstance(name){\n    let options = think.parseConfig.call(this.options, think.config('redis'), {\n      command: name,\n      from: 'cache'\n    });\n    this.timeout = options.timeout || this.timeout;\n    this.prefix = options.prefix || this.prefix;\n    return RedisSocket.getInstance(options, thinkCache.REDIS, ['command', 'from']);\n  }\n  /**\n   * get data\n   * @param  {String} name []\n   * @return {Promise}      []\n   */\n  get(name){\n    let instance = this.getRedisInstance('get');\n    return instance.get(this.prefix + name).then(value => {\n      if (value) {\n        return JSON.parse(value);\n      }\n    }).catch(() => {});\n  }\n  /**\n   * set data\n   * @param {String} name    []\n   * @param {Mixed} value   []\n   * @param {Number} timeout []\n   */\n  set(name, value, timeout = this.timeout){\n    if (think.isObject(name)) {\n      timeout = value || timeout;\n      let key = Object.keys(name)[0];\n      value = name[key];\n      name = key;\n    }\n    let instance = this.getRedisInstance('set');\n    return instance.set(this.prefix + name, JSON.stringify(value), timeout).catch(() => {});\n  }\n  /**\n   * delete data\n   * @param  {String} name []\n   * @return {Promise}      []\n   */\n  delete(name){\n    let instance = this.getRedisInstance('delete');\n    return instance.delete(this.prefix + name).catch(() => {});\n  }\n  /**\n   * wrap\n   * @param  {[type]}    name []\n   * @param  {...[type]} data []\n   * @return {[type]}         []\n   */\n  wrap(command, name, ...data){\n    let instance = this.getRedisInstance(command);\n    return instance.wrap(command, this.prefix + name, ...data);\n  }\n}"]}